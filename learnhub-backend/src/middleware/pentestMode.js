// Middleware to toggle between secure and vulnerable demo modes
// Mode is passed via header `X-Pentest-Mode: vuln|secure` (or query `pentest`)
// Default: secure. Disabled in production.

module.exports = function pentestMode(req, _res, next) {
  const raw =
    req.headers['x-pentest-mode'] ||
    req.query.pentest ||
    req.query.pentestMode ||
    req.query.mode;

  const mode =
    raw && typeof raw === 'string' && raw.toLowerCase().includes('vul')
      ? 'vuln'
      : 'secure';

  // Do not allow vulnerable mode in production for safety
  if (process.env.NODE_ENV === 'production') {
    req.pentestMode = 'secure';
    return next();
  }

  req.pentestMode = mode;
  next();
};

