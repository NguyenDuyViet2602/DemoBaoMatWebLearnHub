const { sequelize } = require('../models');
const { QueryTypes } = require('sequelize');

// ‚ö†Ô∏è PENTEST DEMO SERVICE - CH·ª®A L·ªñ H·ªîNG SQL INJECTION C·ªê √ù ‚ö†Ô∏è

// In-memory storage cho XSS stored demo (thay v√¨ database th·∫≠t)
let commentsStorage = [];

/**
 * L∆∞u comment (kh√¥ng sanitize) - XSS Stored Demo
 */
exports.saveComment = async (comment, author) => {
    const newComment = {
        id: commentsStorage.length + 1,
        comment: comment, // ‚ö†Ô∏è Kh√¥ng sanitize
        author: author || 'Anonymous',
        createdAt: new Date().toISOString()
    };
    
    commentsStorage.push(newComment);
    return newComment;
};

/**
 * L·∫•y danh s√°ch comments - XSS Stored Demo
 */
exports.getComments = async () => {
    return commentsStorage;
};

/**
 * SQL Injection - Search vulnerability
 * ‚ö†Ô∏è VULNERABILITY: S·ª≠ d·ª•ng string concatenation thay v√¨ parameterized query
 */
exports.sqliSearch = async (query) => {
    try {
        // ‚ö†Ô∏è NGUY HI·ªÇM: Raw SQL v·ªõi string concatenation
        const sql = `SELECT userid, fullname, email, role 
                     FROM users 
                     WHERE fullname LIKE '%${query}%' 
                     OR email LIKE '%${query}%'`;
        
        const results = await sequelize.query(sql, {
            type: QueryTypes.SELECT
        });
        
        return results;
    } catch (error) {
        throw new Error(`SQL Error: ${error.message}`);
    }
};

/**
 * SQL Injection - Login bypass vulnerability
 * ‚ö†Ô∏è VULNERABILITY: SQL Injection trong authentication
 */
exports.sqliLogin = async (username, password) => {
    try {
        // ‚ö†Ô∏è NGUY HI·ªÇM: Raw SQL v·ªõi string concatenation
        // Payload: ' OR 1=1 --
        const sql = `SELECT userid, fullname, email, role, passwordhash FROM users WHERE fullname = '${username}' AND passwordhash = '${password}'`;
        
        // Debug: Log SQL query ƒë·ªÉ xem injection
        console.log('üî¥ SQL INJECTION DEBUG:');
        console.log('Username input:', username);
        console.log('Password input:', password);
        console.log('Generated SQL:', sql);
        
        const results = await sequelize.query(sql, {
            type: QueryTypes.SELECT
        });
        
        console.log('Results count:', results.length);
        
        // Trong th·ª±c t·∫ø, password ph·∫£i ƒë∆∞·ª£c hash, nh∆∞ng ƒë√¢y l√† demo
        if (results.length > 0) {
            return {
                id: results[0].userid,
                username: results[0].fullname,
                email: results[0].email,
                role: results[0].role
            };
        }
        
        return null;
    } catch (error) {
        throw new Error(`SQL Error: ${error.message}`);
    }
};

/**
 * SQL Injection - User info v·ªõi UNION SELECT vulnerability
 * ‚ö†Ô∏è VULNERABILITY: UNION SELECT injection
 */
exports.sqliGetUser = async (id) => {
    try {
        // ‚ö†Ô∏è NGUY HI·ªÇM: Raw SQL v·ªõi string concatenation
        // Payload: 1 UNION SELECT fullname, passwordhash, email FROM users--
        const sql = `SELECT userid, fullname, email 
                     FROM users 
                     WHERE userid = ${id}`;
        
        const results = await sequelize.query(sql, {
            type: QueryTypes.SELECT
        });
        
        return results;
    } catch (error) {
        throw new Error(`SQL Error: ${error.message}`);
    }
};

